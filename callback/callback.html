<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">
    <meta name="format-detection" content="telephone=no,address=no,email=no">
    <title>制图回调-图聚智能</title
    <script src="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js"></script>
     <style>
       h4,h5{
         font-weight: normal;
         margin-left: 20px;
       }
       li{
         line-height: 20px;
       }
       span{
         margin-right: 30px;
       }
       table{
         border-collapse: collapse;
         border: 1px solid #000;
       }
       td{
         border: 1px solid #000;
         line-height: 20px;
         padding: 7px;
         text-align: center;
       }
       button{
         padding: 10px 20px;
         background-color: #227fd5;
         border: none;
         color: #fff;
         border-radius: 5px;
         cursor: pointer;
       }
       button:disabled{
         background-color: #ddd;
         cursor: not-allowed;
       }
       input[type=file]{
         width: 200px;
       }
     </style>
  </head>
  <body>
     <h3>您有新的制图订单</h3>
     <h4 id="orderNum">订单号：<span></span></h4>
     <h4 id="shopName">场所名：<span></span>制图完成后请填写MAP ID：<span><input type="text" id="mapId" onchange="enableClick()"/></span></h4>
     <h4 id="userInfo">用户名：<span></span>用户邮箱：<span></span>用户手机：<span></span></h4>
     <h4>制图完成后请填写表格，并提交</h4>
     <h5>
       说明：
       <ol>
         <li>同用户沟通后，如果用户需要重新上传楼层地图资料，请点击对应的重新上传按钮。重新上传按钮5分钟内只能点击一次。</li>
         <li>图聚位图导出后的图片请勿修改文件名！</li>
         <li>请仔细检查FloorID，建筑物名称图聚位图和用户提交的楼层地图的对应关系，填写错误或者上传错误的图片会导致用户地图出错。</li>
         <li>建筑物名称请填写Building Name。</li>
       </ol>
       注：图聚位图是Palmap Tool导出的png图片。
     </h5>
      <table>
        <tr>
          <td>通知用户重新上传地图资料</td>
          <td>楼层地图资料名</td>
          <td>地址</td>
          <td>百度地图坐标</td>
          <td>比例尺</td>
          <td>楼层地图资料下载链接</td>
          <td>请填写Floor ID</td>
          <td>请填写建筑物名称</td>
          <td>请上传图聚位图</td>
        </tr>
      </table>
      <h4>请上传xml文件：<input type="file" onchange="sendList(this.files,'xml')" accept="text/xml, application/xml"/></h4>
      <div style="text-align:center;">
        <button id="completeBtn" disabled onclick="sendMsg()">完成制图，提交</button>
      </div>

      <script>
        var list = Array();
        var gl_h3c = {
          uri : `https://h3c.ipalmap.com/apiv3/`,
          shopId : 0,
          department: 0,
          floors:[]
        }
        window.onload = function(){
          getAndSetInfo();
          var list = document.getElementsByClassName("reApply");
          for(let i = 0; i < list.length ; i++){
            list[i].addEventListener('click',function(e){
              var btn = e.currentTarget;
              btn.setAttribute('disabled', true);
              var count = 5 * 60;
              var timeId = setInterval(function(){
                count--
                if (count === 0) {
                  clearInterval(timeId);
                  btn.removeAttribute('disabled');
                }
              }, 1000);
            });
          }
        }
        //上传文件 promise
        function uploadFile(file,type,index){
            return new Promise(function(resolve,reject){
                var xhr = new XMLHttpRequest(); 
                var fd = new FormData();
                console.log(type);
                if(type == 'file'){
                    uri = `${gl_h3c.uri}shops/${gl_h3c.shopId}/maps/files`;
                }else{
                    uri = `${gl_h3c.uri}shops/${gl_h3c.shopId}/xml/files`;
                }
                xhr.addEventListener("error", reject);
                xhr.addEventListener("load", function(e){
                  var data = eval('(' + xhr.response + ')');
                  if(type == 'xml'){
                    setXAndY(data);
                  }
                  enableClick();
                  if(!index){return;}
                  document.getElementById('bitmapId_' + index).value = data.bitmapId;
                  document.getElementById('bitmapUrl_' + index).value = data.bitmapUrl;
                  
                });
                xhr.open("POST",uri,true);
                
                fd.append('file',file[0]);
                xhr.send(fd);
                
                
            })
        }
        // add a promise to list
        function sendList(file,type,index){
            list.push(uploadFile(file,type,index));
        }
        //when all file sent successfully , enable button
        function enableClick(){
          var list = document.querySelectorAll("input");
          // var list = document.querySelectorAll("input[type=file]");
          var ele = document.getElementById("mapId");
          if(!ele.value){return;}
          for(let i = 0 ; i < list.length; i++){
            if(!list[i]['value']){
              return;
            }
          }
          var list = document.querySelectorAll("input");

            Promise.all(list).then(values => { 
              console.log(list);
                document.getElementById('completeBtn').disabled = false;
            }).catch(reason => {
              console.log(reason);
            });
            
        }
        function getAndSetInfo(){
           var paramstr = window.location.search.substr(1);
           var paramarr = paramstr.split("&");
           var order , department;
           for(let i = 0 ; i < paramarr.length ; i++){
              var arr = paramarr[i].split("=");
              if(arr[0] == "orderNum"){
                 order = arr[1];
              }else if(arr[0] == "shopId"){
                gl_h3c.shopId = arr[1];
              }else{
                department = arr[1];
                gl_h3c.department = arr[1];
              }
           }
           var getInfo = new Promise(function(resolve,reject){
                var xhr = new XMLHttpRequest(); 
                var uri = `${gl_h3c.uri}orders?orderNum=${order}&shopId=${gl_h3c.shopId}`;
                xhr.open("GET",uri,true);
                xhr.addEventListener("error", reject);
                xhr.addEventListener("load", resolve);
                xhr.send();
              }).then(function(e){
                  var data = e.currentTarget.response;
                  var list = eval("(" + data + ")");
                  setInfo(list);
                  console.log(list);
           });
           var getTableInfo = new Promise(function(resolve,reject){
               var xhr = new XMLHttpRequest(); 
                var uri = `${gl_h3c.uri}orders/maps?dataDepartmentOrderId=${department}`;
                xhr.open("GET",uri,true);
                xhr.addEventListener("error", reject);
                xhr.addEventListener("load", resolve);
                xhr.send();
              }).then(function(e){
                  var data = e.currentTarget.response;
                  var list = eval("(" + data + ")");
                  setTableInfo(list);
                  
           });
           
        }
        function setInfo(list){
          // gl_h3c.shopId = list['shopId']
          document.getElementById("orderNum").childNodes[1].innerText = list["orderNum"];
          document.getElementById("shopName").childNodes[1].innerText = list["shopName"];
          document.getElementById("userInfo").childNodes[1].innerText = list["userName"];
          document.getElementById("userInfo").childNodes[3].innerText = list["email"];
          document.getElementById("userInfo").childNodes[5].innerText = list["telephone"];
          // document.getElementById("orderNum").childNodes[1].innerText = list["orderNum"];
        }
        function setTableInfo(list){
           for(let i = 1 ; i <= list["mapInfos"].length ; i++){
             addRow(list["mapInfos"][i-1],i);
           }
        }
        function addRow(data,index){
          //  console.log(data);
           var table = document.getElementsByTagName("table")[0];
           var newRow = table.insertRow(index);
           var cell = [];
           for(let i = 0 ; i < 9 ; i++){
             cell[i] = newRow.insertCell(i);
           }
           cell[0].innerHTML = '<button class="reApply">重新提供地图资料</button>';
           cell[1].innerHTML = data["imageName"];
           cell[2].innerHTML = data["address"];
           cell[3].innerHTML = data["publicAddress"];
           cell[4].innerHTML = data["scale"];
           cell[5].innerHTML = "<a href='" +data["imageUrl"]+ "'>下载链接</a>";
           cell[6].innerHTML = `<input type="text" id="floorId_${index}" onchange="enableClick()"/>`;
           cell[7].innerHTML = `<input type="text" id="buildingName_${index}" onchange="enableClick()"/>`;
           cell[8].innerHTML = `<input type="file" id="file_${index}" onchange="sendList(this.files,'file',${index})"/>` + 
           `<input type="text" id="bitmapId_${index}" style="display:none">` + 
           `<input type="text" id="bitmapUrl_${index}" style="display:none">` + 
          `<input type="text" id="imageId_${index}" style="display:none" value=${data['imageId']}>`;
        }
        function sendMsg(){
          document.getElementById('completeBtn').disabled = true;
          var data = {
            dataDepartmentOrderId:gl_h3c.department,
            mapId:document.getElementById('mapId').value,
            maps:[],
          }
          var trs= document.getElementsByTagName('tr');
          for(let i = 1 ; i < trs.length ; i++){
            var filename = document.getElementById('file_' + i).files[0].name;
            filename = filename.split('.')[0];
            var obj = {
              imageId: parseInt(document.getElementById('imageId_' + i).value),
              floorId: parseInt(document.getElementById('floorId_' + i).value),
              buildingName: document.getElementById('buildingName_' + i).value,
              x: getXByFileName(filename),
              y: getXByFileName(filename),
              scale: trs[i].childNodes[4].innerText,
              bitmapId: document.getElementById('bitmapId_' + i).value,
              bitmapUrl: document.getElementById('bitmapUrl_' + i).value
            };
            data.maps.push(obj);
          }
          var uri = `${gl_h3c.uri}shops/${gl_h3c.shopId}/maps`;
          var xhr = new XMLHttpRequest(); 
          var fd = new FormData();
          xhr.addEventListener('load',function(){
            if(xhr.status != '200'){
              alert("提交失败");
              document.getElementById('completeBtn').disabled = false;
            }else{
              alert("提交成功");
              clearInput();
            }
          })
          xhr.open("POST",uri,true);
          xhr.setRequestHeader('Content-type','application/json');
          xhr.send(JSON.stringify(data));
        }
        function clearInput(){
          var list = document.getElementsByTagName('input');
          for(let i = 0 ; i < list.length ; i++){
            list[i].value = '';
          }
        }
        function setXAndY(data){
          gl_h3c.floors = data.floors;
        }
        function getXByFileName(name){
          var x = '';
          for(var i = 0 ;i < gl_h3c.floors.length ; i++ ){
            if(gl_h3c.floors[i].fileName == name){
              x = gl_h3c.floors[i].x;
            }
          }
          return x;
        }
        function getYByFileName(name){
           gl_h3c.floors.forEach(function(e){
            if(e.fileName == name){
              return e.y;
            }
          });
        }
        
      </script>
  </body>
</html>
